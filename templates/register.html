<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>
        {% block title %}
            ğŸ¹ æ³¨å†Œç•Œé¢
        {% endblock %}
    </title>
    {% load static %}
    <script src="{% static 'jquery-3.4.1/jquery.min.js' %}"></script>
    <link href="{% static 'bootstrap-3.3.7/css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="{% static 'bootstrap-3.3.7/js/bootstrap.min.js' %}"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <style>
        {% block css %}
            body {
                background-image: url("{% static 'img/21.jpg' %}");
            }
            .c1 {
                margin-top: 80px;
                background: rgba(0, 0, 0, 0.3);
                padding-top: 20px;
            }

            #id_img {
                border-radius: 50%;
                border: 3px solid #87b4ea;
                display: block;
                margin: 5px auto;
            }

            .img_div {
                text-align: center;
            }

            .c2 {
                background: rgba(255, 255, 255, 0.2);
                border: 0;
                width: 400px;
                margin: auto;
            }
        {% endblock %}
    </style>
</head>
<body>
<div class="container-fluid c1">
    <div class="row">
        <div class="col-md-4 col-md-offset-4 ">
            <div class="panel panel-success c2">
                {% block body %}
                    <div class="panel-heading text-center">
                        <h3 class="panel-title">æ³¨å†Œ</h3>
                    </div>
                    <div class="panel-body">
                        <form id="my_form">
                            <div class="form-group img_div">
                                <label for="myfile">
                                    <img alt='' src="/static/img/default.png" id='id_img' width="80px" height="80px">
                                </label>
                                <div>è®¾ç½®å¤´åƒ</div>
                                <input type="file" id="myfile" style="display: none">
                            </div>
                            {% csrf_token %}
                            {% for foo in register_form %}
                                <div class="form-group">
                                    <label for="{{ foo.auto_id }}">{{ foo.label }}</label>
                                    {{ foo }}
                                </div>
                            {% endfor %}
                        </form>
                        <input type="submit" value="æ³¨å†Œ" class="btn btn-block btn-warning" id="id_submit"><br>
                        <a href="{% url 'login_name' %}" class="btn btn-block btn-warning">Go login</a>
                        <div style="display: none"> {# åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ #}
                            {% for user_name in user_name_list %}
                                <input class="inp" value="{{ user_name }}">
                            {% endfor %}
                        </div>
                    </div>
                {% endblock %}
            </div>
        </div>
    </div>
</div>
</body>


<script>
    {% block script %}
    // æ–‡ä»¶é˜…è¯»å™¨æ“ä½œå¤´åƒ
    $('#myfile').change(function () {
        // å…ˆæ‹¿åˆ°æ–‡ä»¶
        let myfile = $(this)[0].files[0]
        // newä¸€ä¸ªæ–‡ä»¶é˜…è¯»å™¨å¯¹è±¡,å°†æ–‡ä»¶é˜…è¯»åˆ°å¯¹è±¡ä¸­
        let FileReadObj = new FileReader()
        FileReadObj.readAsDataURL(myfile)
        // ç­‰å¾…æ–‡ä»¶é˜…è¯»å®Œæˆ,å†domæ“ä½œåˆ°imgæ ‡ç­¾ä¸Š
        FileReadObj.onload = function () {
            $('#id_img').attr('src', FileReadObj.result)
        }
    })
    // usernameè¾“å…¥æ¡†å¤±ç„¦äº‹ä»¶
    $('#id_username').blur(function () {
        $('.inp').each(function () {
            if ($('#id_username').val() === $(this).val()) {
                swal("ç”¨æˆ·å·²å­˜åœ¨", {icon: "warning",})
                $('#id_username').val('')
            }
        })
    })
    // ç‚¹å‡»æŒ‰é’®,formè¡¨å•åŠFormDataå¯¹è±¡æ·»åŠ æ•°æ®
    $('#id_submit').click(function () {
        // åˆ›å»ºä¸€ä¸ªFormDataå¯¹è±¡
        let FormDataObj = new FormData()
        // å…ˆå°†æ–‡ä»¶å–åˆ°æ·»åŠ è¿›å»
        FormDataObj.append('myfile', $('#myfile')[0].files[0])
        // å†å°†åå­—å¯†ç ç­‰æ”¾è¿›å»
        // ä½¿ç”¨serializeArray()æ–¹æ³•è·å–formè¡¨å•ä¸‹æ‰€æœ‰çš„key:valueå€¼çš„æ•°ç»„
        let form_data = $('#my_form').serializeArray()
        // ä½¿ç”¨eachå¾ªç¯å°†æ•°ç»„é‡Œçš„key:valueå–å‡ºæ¥æ·»åŠ è¿›FormDataå¯¹è±¡ä¸­å»
        $.each(form_data, function (index, element) {
            FormDataObj.append(element.name, element.value)
        })
        // ajaxè¯·æ±‚æäº¤æ•°æ®
        $.ajax({
            url: '{% url 'register_name' %}',
            method: 'post',
            contentType: false,
            processData: false,
            data: FormDataObj,
            success: function (data) {
                if (data.status === 100) {
                    swal({
                        title: data.msg,
                        text: $('#id_username').val(),
                        icon: "success",
                        buttons: ["ç»§ç»­æ³¨å†Œ", "å‰å¾€ç™»å…¥"],
                        dangerMode: true,
                    })
                        .then((willDelete) => {
                            if (willDelete) {
                                location.href = data.next_url;
                            } else {
                                location.href = '{% url 'register_name' %}';
                            }
                        });
                } else {
                    // é”™è¯¯çš„ç»“æœè¿”å›errorså­—å…¸,æ ¼å¼:{'username': [é”™è¯¯ä¿¡æ¯1,é”™è¯¯ä¿¡æ¯2,...], ...}
                    $.each(data.msg, function (key, value) {
                        // é”™è¯¯çš„æ¡†æ·»åŠ çº¢è‰²è¾¹æ¡†
                        $('#id_' + key).parent().addClass('has-error')
                        swal({
                            title: 'æ³¨å†Œå¤±è´¥',
                            text: value[0],
                            icon: "warning",
                            dangerMode: true,
                        })
                    })
                }
            }
        })
    })
    // å½“ç”¨æˆ·ç‚¹å‡»è¾“å…¥æ¡†æ—¶æ¸…é™¤has-erroræ•ˆæœ(èšç„¦)(æˆ–è€…ä½¿ç”¨å®šæ—¶å™¨)
    $('input').focus(function () {
        $('.form-group').removeClass('has-error')
    })
    {% endblock %}
</script>
</html>